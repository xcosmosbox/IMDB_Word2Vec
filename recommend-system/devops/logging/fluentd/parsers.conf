# =============================================================================
# Fluentd 解析器配置
# 
# 定义各种日志格式的解析规则
# 符合 interfaces.yaml 中的日志格式契约
# =============================================================================

# =============================================================================
# JSON 解析器 (标准日志格式)
# =============================================================================

# 标准 JSON 日志解析器 (符合 interfaces.yaml 契约)
<parse>
  @type json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  
  # 类型转换
  types duration_ms:integer,user_id:string,request_id:string
</parse>

# =============================================================================
# Go 服务日志解析器
# =============================================================================

# Go 服务 JSON 日志
<parse>
  @type json
  @id go_service_json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  
  types duration_ms:integer,status_code:integer
</parse>

# Go 服务纯文本日志 (备用)
<parse>
  @type regexp
  @id go_service_text
  expression /^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z?)\s+(?<level>\w+)\s+(?<service>\S+)\s+\[(?<trace_id>[^\]]*)\]\s+(?<message>.*)$/
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
</parse>

# =============================================================================
# Python 推理服务日志解析器
# =============================================================================

# Python JSON 日志
<parse>
  @type json
  @id python_inference_json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  
  types latency_ms:float,batch_size:integer,gpu_memory_mb:integer
</parse>

# Python 标准日志格式 (备用)
<parse>
  @type regexp
  @id python_standard
  expression /^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+-\s+(?<service>\S+)\s+-\s+(?<level>\w+)\s+-\s+(?<message>.*)$/
  time_key timestamp
  time_format %Y-%m-%d %H:%M:%S,%L
</parse>

# =============================================================================
# Kubernetes 日志解析器
# =============================================================================

# Docker JSON 日志格式
<parse>
  @type json
  @id docker_json
  time_key time
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
</parse>

# CRI 日志格式 (containerd)
<parse>
  @type regexp
  @id cri_format
  expression /^(?<time>.+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$/
  time_key time
  time_format %Y-%m-%dT%H:%M:%S.%N%:z
</parse>

# =============================================================================
# 系统日志解析器
# =============================================================================

# Syslog 格式
<parse>
  @type syslog
  @id syslog_parser
  with_priority false
  message_format auto
</parse>

# Journal 日志格式
<parse>
  @type regexp
  @id journal_format
  expression /^(?<timestamp>\w+ \d+ \d+:\d+:\d+)\s+(?<host>\S+)\s+(?<program>\S+?)(\[(?<pid>\d+)\])?:\s+(?<message>.*)$/
  time_key timestamp
  time_format %b %d %H:%M:%S
</parse>

# =============================================================================
# Nginx 访问日志解析器
# =============================================================================

<parse>
  @type regexp
  @id nginx_access
  expression /^(?<remote_addr>[^ ]*) - (?<remote_user>[^ ]*) \[(?<time_local>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<status>[^ ]*) (?<body_bytes_sent>[^ ]*)(?: "(?<http_referer>[^\"]*)" "(?<http_user_agent>[^\"]*)")?$/
  time_key time_local
  time_format %d/%b/%Y:%H:%M:%S %z
  types status:integer,body_bytes_sent:integer
</parse>

# =============================================================================
# 多行日志解析器 (异常堆栈)
# =============================================================================

# Go 堆栈跟踪
<parse>
  @type multiline
  @id go_stacktrace
  format_firstline /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/
  format1 /^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z?)\s+(?<level>\w+)\s+(?<message>.*)/
</parse>

# Python 堆栈跟踪
<parse>
  @type multiline
  @id python_stacktrace
  format_firstline /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/
  format1 /^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+-\s+(?<service>\S+)\s+-\s+(?<level>\w+)\s+-\s+(?<message>.*)/
</parse>

# Java 堆栈跟踪 (如果需要)
<parse>
  @type multiline
  @id java_stacktrace
  format_firstline /^\d{4}-\d{2}-\d{2}[\sT]\d{2}:\d{2}:\d{2}/
  format1 /^(?<timestamp>\d{4}-\d{2}-\d{2}[\sT]\d{2}:\d{2}:\d{2}[.,]\d{3})\s+(?<level>\w+)\s+\[(?<thread>[^\]]+)\]\s+(?<logger>\S+)\s+-\s+(?<message>.*)/
</parse>

# =============================================================================
# 自定义业务日志解析器
# =============================================================================

# 推荐请求日志
<parse>
  @type json
  @id recommend_request
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  
  types user_id:string,item_count:integer,latency_ms:float,cache_hit:bool
</parse>

# 用户行为日志
<parse>
  @type json
  @id user_behavior
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  
  types user_id:string,item_id:string,action_type:string,duration_s:float
</parse>

# 模型推理日志
<parse>
  @type json
  @id model_inference
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  
  types model:string,batch_size:integer,latency_ms:float,gpu_util:float,memory_mb:integer
</parse>

