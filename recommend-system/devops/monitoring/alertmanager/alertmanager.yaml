# =============================================================================
# AlertManager é…ç½®
#
# ç”Ÿæˆå¼æ¨èç³»ç»Ÿå‘Šè­¦ç®¡ç†é…ç½®
# æ”¯æŒ Slackã€PagerDutyã€é‚®ä»¶ç­‰å¤šç§å‘Šè­¦æ¸ é“
# =============================================================================

global:
  # å‘Šè­¦è§£å†³è¶…æ—¶
  resolve_timeout: 5m
  
  # Slack Webhook URL (é€šè¿‡ç¯å¢ƒå˜é‡æˆ– Secret æ³¨å…¥)
  slack_api_url: '{{ .SlackWebhookURL }}'
  
  # SMTP é…ç½® (é‚®ä»¶å‘Šè­¦)
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@example.com'
  smtp_auth_username: '{{ .SMTPUsername }}'
  smtp_auth_password: '{{ .SMTPPassword }}'
  smtp_require_tls: true

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡ Downï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['service']
  
  # å¦‚æœæœ‰ Critical çº§åˆ«å‘Šè­¦ï¼ŒæŠ‘åˆ¶åŒæœåŠ¡çš„ Warning å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'alertname']
  
  # å¦‚æœèŠ‚ç‚¹ Downï¼ŒæŠ‘åˆ¶è¯¥èŠ‚ç‚¹ä¸Šçš„ Pod å‘Šè­¦
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: '.*'
    equal: ['node']
  
  # PostgreSQL Down æ—¶æŠ‘åˆ¶ PostgreSQL ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: 'PostgresDown'
    target_match_re:
      alertname: 'Postgres.*'
    equal: ['instance']
  
  # Redis Down æ—¶æŠ‘åˆ¶ Redis ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: 'RedisDown'
    target_match_re:
      alertname: 'Redis.*'
    equal: ['instance']

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default-receiver'
  
  # åˆ†ç»„ä¾æ®
  group_by: ['alertname', 'severity', 'service']
  
  # åˆ†ç»„ç­‰å¾…æ—¶é—´ (èšåˆåŒç»„å‘Šè­¦)
  group_wait: 30s
  
  # åŒç»„å‘Šè­¦å‘é€é—´éš”
  group_interval: 5m
  
  # é‡å¤å‘é€é—´éš”
  repeat_interval: 4h
  
  # å­è·¯ç”±
  routes:
    # ==========================================================================
    # Critical å‘Šè­¦ - ç«‹å³é€šçŸ¥ + PagerDuty
    # ==========================================================================
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 1h
      continue: false
    
    # ==========================================================================
    # æ¨ç†æœåŠ¡å‘Šè­¦ - ML å›¢é˜Ÿ
    # ==========================================================================
    - match:
        team: ml
      receiver: 'ml-team-alerts'
      group_wait: 30s
      repeat_interval: 2h
      routes:
        - match:
            severity: critical
          receiver: 'ml-team-critical'
          group_wait: 10s
          repeat_interval: 30m
    
    # ==========================================================================
    # æ•°æ®åº“å‘Šè­¦ - DBA å›¢é˜Ÿ
    # ==========================================================================
    - match:
        team: dba
      receiver: 'dba-team-alerts'
      group_wait: 30s
      repeat_interval: 2h
      routes:
        - match:
            severity: critical
          receiver: 'dba-team-critical'
          group_wait: 10s
          repeat_interval: 30m
    
    # ==========================================================================
    # ä¸šåŠ¡å‘Šè­¦ - äº§å“å›¢é˜Ÿ
    # ==========================================================================
    - match_re:
        alertname: 'Low.*CTR|High.*CacheHitMiss|RecommendationRequest.*'
      receiver: 'business-alerts'
      group_wait: 5m
      repeat_interval: 6h
    
    # ==========================================================================
    # å®‰å…¨å‘Šè­¦ - å®‰å…¨å›¢é˜Ÿ
    # ==========================================================================
    - match:
        team: security
      receiver: 'security-alerts'
      group_wait: 10s
      repeat_interval: 1h
    
    # ==========================================================================
    # Warning å‘Šè­¦
    # ==========================================================================
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 4h
    
    # ==========================================================================
    # Info å‘Šè­¦ (ä»…è®°å½•ï¼Œä¸å‘é€)
    # ==========================================================================
    - match:
        severity: info
      receiver: 'null-receiver'

# æ¥æ”¶è€…é…ç½®
receivers:
  # ==========================================================================
  # é»˜è®¤æ¥æ”¶è€…
  # ==========================================================================
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: '{{ template "slack.color" . }}'
        actions:
          - type: button
            text: 'æŸ¥çœ‹ Dashboard'
            url: '{{ template "slack.dashboard_url" . }}'
          - type: button
            text: 'æŸ¥çœ‹ Runbook'
            url: '{{ template "slack.runbook_url" . }}'
  
  # ==========================================================================
  # Critical å‘Šè­¦æ¥æ”¶è€…
  # ==========================================================================
  - name: 'critical-alerts'
    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true
        title: 'ğŸš¨ {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: 'danger'
        actions:
          - type: button
            text: 'ğŸ“Š Dashboard'
            url: '{{ template "slack.dashboard_url" . }}'
          - type: button
            text: 'ğŸ“– Runbook'
            url: '{{ template "slack.runbook_url" . }}'
    pagerduty_configs:
      - service_key: '{{ .PagerDutyServiceKey }}'
        severity: critical
        description: '{{ template "pagerduty.description" . }}'
        details:
          firing: '{{ template "pagerduty.firing" . }}'
          resolved: '{{ template "pagerduty.resolved" . }}'
    email_configs:
      - to: 'oncall@example.com'
        send_resolved: true
        html: '{{ template "email.html" . }}'
        headers:
          Subject: '[CRITICAL] {{ template "email.subject" . }}'
  
  # ==========================================================================
  # Warning å‘Šè­¦æ¥æ”¶è€…
  # ==========================================================================
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#alerts-warning'
        send_resolved: true
        title: 'âš ï¸ {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: 'warning'
  
  # ==========================================================================
  # ML å›¢é˜Ÿå‘Šè­¦
  # ==========================================================================
  - name: 'ml-team-alerts'
    slack_configs:
      - channel: '#ml-alerts'
        send_resolved: true
        title: 'ğŸ¤– {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
  
  - name: 'ml-team-critical'
    slack_configs:
      - channel: '#ml-alerts'
        send_resolved: true
        title: 'ğŸš¨ [ML Critical] {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: 'danger'
    pagerduty_configs:
      - service_key: '{{ .MLPagerDutyServiceKey }}'
        severity: critical
  
  # ==========================================================================
  # DBA å›¢é˜Ÿå‘Šè­¦
  # ==========================================================================
  - name: 'dba-team-alerts'
    slack_configs:
      - channel: '#dba-alerts'
        send_resolved: true
        title: 'ğŸ—„ï¸ {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
  
  - name: 'dba-team-critical'
    slack_configs:
      - channel: '#dba-alerts'
        send_resolved: true
        title: 'ğŸš¨ [DB Critical] {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: 'danger'
    pagerduty_configs:
      - service_key: '{{ .DBAPagerDutyServiceKey }}'
        severity: critical
  
  # ==========================================================================
  # ä¸šåŠ¡å‘Šè­¦
  # ==========================================================================
  - name: 'business-alerts'
    slack_configs:
      - channel: '#business-metrics'
        send_resolved: true
        title: 'ğŸ“Š {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: '{{ template "slack.color" . }}'
  
  # ==========================================================================
  # å®‰å…¨å‘Šè­¦
  # ==========================================================================
  - name: 'security-alerts'
    slack_configs:
      - channel: '#security-alerts'
        send_resolved: true
        title: 'ğŸ”’ {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: 'danger'
    email_configs:
      - to: 'security@example.com'
        send_resolved: true
        headers:
          Subject: '[SECURITY] {{ template "email.subject" . }}'
  
  # ==========================================================================
  # ç©ºæ¥æ”¶è€… (ç”¨äºå¿½ç•¥æŸäº›å‘Šè­¦)
  # ==========================================================================
  - name: 'null-receiver'

