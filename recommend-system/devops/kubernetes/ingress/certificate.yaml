# Certificate 配置
# 使用 cert-manager 自动管理 TLS 证书
---
# ClusterIssuer - Let's Encrypt Production
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  labels:
    app.kubernetes.io/name: letsencrypt-prod
    app.kubernetes.io/part-of: generative-recsys
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: devops@recommend.example.com
    privateKeySecretRef:
      name: letsencrypt-prod-account-key
    solvers:
      # HTTP-01 验证
      - http01:
          ingress:
            class: nginx
        selector:
          dnsZones:
            - "recommend.example.com"
      # DNS-01 验证 (用于通配符证书)
      - dns01:
          cloudDNS:
            project: your-gcp-project
            serviceAccountSecretRef:
              name: clouddns-service-account
              key: key.json
        selector:
          dnsZones:
            - "recommend.example.com"
---
# ClusterIssuer - Let's Encrypt Staging (用于测试)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  labels:
    app.kubernetes.io/name: letsencrypt-staging
    app.kubernetes.io/part-of: generative-recsys
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: devops@recommend.example.com
    privateKeySecretRef:
      name: letsencrypt-staging-account-key
    solvers:
      - http01:
          ingress:
            class: nginx
---
# API 域名证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: recommend-api-cert
  labels:
    app.kubernetes.io/name: recommend-api-cert
    app.kubernetes.io/part-of: generative-recsys
spec:
  secretName: recommend-api-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: api.recommend.example.com
  dnsNames:
    - api.recommend.example.com
  duration: 2160h  # 90 天
  renewBefore: 360h  # 提前 15 天续期
  privateKey:
    algorithm: RSA
    size: 2048
    rotationPolicy: Always
---
# Admin 域名证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: recommend-admin-cert
  labels:
    app.kubernetes.io/name: recommend-admin-cert
    app.kubernetes.io/part-of: generative-recsys
spec:
  secretName: recommend-admin-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: admin.recommend.example.com
  dnsNames:
    - admin.recommend.example.com
  duration: 2160h
  renewBefore: 360h
  privateKey:
    algorithm: RSA
    size: 2048
---
# User App 域名证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: recommend-user-cert
  labels:
    app.kubernetes.io/name: recommend-user-cert
    app.kubernetes.io/part-of: generative-recsys
spec:
  secretName: recommend-user-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: recommend.example.com
  dnsNames:
    - recommend.example.com
    - www.recommend.example.com
  duration: 2160h
  renewBefore: 360h
  privateKey:
    algorithm: RSA
    size: 2048
---
# gRPC 域名证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: recommend-grpc-cert
  labels:
    app.kubernetes.io/name: recommend-grpc-cert
    app.kubernetes.io/part-of: generative-recsys
spec:
  secretName: recommend-grpc-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: grpc.recommend.example.com
  dnsNames:
    - grpc.recommend.example.com
  duration: 2160h
  renewBefore: 360h
  privateKey:
    algorithm: RSA
    size: 2048
---
# 通配符证书 (需要 DNS-01 验证)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: recommend-wildcard-cert
  labels:
    app.kubernetes.io/name: recommend-wildcard-cert
    app.kubernetes.io/part-of: generative-recsys
spec:
  secretName: recommend-wildcard-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: "*.recommend.example.com"
  dnsNames:
    - "*.recommend.example.com"
    - recommend.example.com
  duration: 2160h
  renewBefore: 360h
  privateKey:
    algorithm: RSA
    size: 2048
---
# Istio Gateway 使用的证书凭据
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: recommend-tls-credential
  namespace: istio-system
  labels:
    app.kubernetes.io/name: recommend-tls-credential
    app.kubernetes.io/part-of: generative-recsys
spec:
  secretName: recommend-tls-credential
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: "*.recommend.example.com"
  dnsNames:
    - "*.recommend.example.com"
    - recommend.example.com
    - api.recommend.example.com
    - admin.recommend.example.com
    - grpc.recommend.example.com
  duration: 2160h
  renewBefore: 360h
  privateKey:
    algorithm: RSA
    size: 2048

