# =============================================================================
# 持续集成工作流
# 
# 触发条件: push 到 main/develop 分支，或 pull_request
# 任务: 代码检查、测试、构建
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'recommend-system/**'
      - '.github/workflows/ci.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'recommend-system/**'

env:
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '20'
  REGISTRY: ${{ secrets.DOCKER_REGISTRY_URL }}

# 并发控制：同一分支的新推送会取消旧的运行
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # 变更检测 - 确定需要运行哪些检查
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
      python: ${{ steps.filter.outputs.python }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            go:
              - 'recommend-system/**/*.go'
              - 'recommend-system/go.mod'
              - 'recommend-system/go.sum'
            python:
              - 'recommend-system/algorithm/**/*.py'
              - 'recommend-system/algorithm/requirements.txt'
            frontend:
              - 'recommend-system/frontend/**'
              - '!recommend-system/frontend/**/*.md'

  # ==========================================================================
  # Go 后端检查
  # ==========================================================================
  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.go == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: recommend-system/go.sum
      
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.55
          working-directory: ./recommend-system
          args: --timeout=5m

  go-test:
    name: Go Test
    runs-on: ubuntu-latest
    needs: [changes, go-lint]
    if: needs.changes.outputs.go == 'true'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: recommend_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: recommend-system/go.sum
      
      - name: Run unit tests
        working-directory: ./recommend-system
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/recommend_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./recommend-system/coverage.out
          flags: go
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  go-build:
    name: Go Build
    runs-on: ubuntu-latest
    needs: [changes, go-test]
    if: needs.changes.outputs.go == 'true'
    strategy:
      matrix:
        service: [recommend-service, user-service, item-service]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: recommend-system/go.sum
      
      - name: Build ${{ matrix.service }}
        working-directory: ./recommend-system
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -ldflags="-s -w -X main.Version=${{ github.sha }}" \
            -o bin/${{ matrix.service }} ./cmd/${{ matrix.service }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}
          path: recommend-system/bin/${{ matrix.service }}
          retention-days: 7

  # ==========================================================================
  # Python 算法检查
  # ==========================================================================
  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: recommend-system/algorithm/requirements.txt
      
      - name: Install lint tools
        run: |
          pip install flake8 black isort mypy
      
      - name: Run flake8
        working-directory: ./recommend-system/algorithm
        run: |
          flake8 . --max-line-length=100 --exclude=__pycache__,*.pyc,.git
      
      - name: Check black formatting
        working-directory: ./recommend-system/algorithm
        run: |
          black --check --diff .
      
      - name: Check isort
        working-directory: ./recommend-system/algorithm
        run: |
          isort --check-only --diff .
      
      - name: Run mypy
        working-directory: ./recommend-system/algorithm
        continue-on-error: true
        run: |
          mypy . --ignore-missing-imports

  python-test:
    name: Python Test
    runs-on: ubuntu-latest
    needs: [changes, python-lint]
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: recommend-system/algorithm/requirements.txt
      
      - name: Install dependencies
        working-directory: ./recommend-system/algorithm
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run tests
        working-directory: ./recommend-system/algorithm
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html -v \
            --ignore=serving/model_repository
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./recommend-system/algorithm/coverage.xml
          flags: python
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  python-build:
    name: Python Build (UGT Inference)
    runs-on: ubuntu-latest
    needs: [changes, python-test]
    if: needs.changes.outputs.python == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Build wheel
        working-directory: ./recommend-system/algorithm
        run: |
          pip install build wheel
          python -m build --wheel
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ugt-inference-wheel
          path: recommend-system/algorithm/dist/*.whl
          retention-days: 7

  # ==========================================================================
  # 前端检查
  # ==========================================================================
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    strategy:
      matrix:
        app: [user-app, admin]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: recommend-system/frontend/${{ matrix.app }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm run lint
      
      - name: Run TypeScript check
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm run type-check || npx vue-tsc --noEmit

  frontend-test:
    name: Frontend Test
    runs-on: ubuntu-latest
    needs: [changes, frontend-lint]
    if: needs.changes.outputs.frontend == 'true'
    strategy:
      matrix:
        app: [user-app, admin]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: recommend-system/frontend/${{ matrix.app }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm ci
      
      - name: Run tests
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm run test -- --coverage --run
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          flags: frontend-${{ matrix.app }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: [changes, frontend-test]
    if: needs.changes.outputs.frontend == 'true'
    strategy:
      matrix:
        app: [user-app, admin]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: recommend-system/frontend/${{ matrix.app }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm ci
      
      - name: Build
        working-directory: ./recommend-system/frontend/${{ matrix.app }}
        run: npm run build
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-dist
          path: recommend-system/frontend/${{ matrix.app }}/dist
          retention-days: 7

  # ==========================================================================
  # Docker 构建
  # ==========================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [go-build, python-build, frontend-build]
    if: |
      always() && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    strategy:
      matrix:
        include:
          - image: recommend-service
            dockerfile: deployments/docker/Dockerfile
            context: .
          - image: user-service
            dockerfile: deployments/docker/Dockerfile.user
            context: .
          - image: item-service
            dockerfile: deployments/docker/Dockerfile.item
            context: .
          - image: ugt-inference
            dockerfile: algorithm/Dockerfile
            context: ./algorithm
          - image: user-app
            dockerfile: frontend/user-app/Dockerfile
            context: ./frontend/user-app
          - image: admin-app
            dockerfile: frontend/admin/Dockerfile
            context: ./frontend/admin
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY_URL }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_REGISTRY_URL }}/${{ matrix.image }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./recommend-system/${{ matrix.context }}
          file: ./recommend-system/${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}

  # ==========================================================================
  # CI 完成通知
  # ==========================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [go-build, python-build, frontend-build, docker-build]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "CI failed"
            exit 1
          fi
          echo "CI passed successfully"
      
      - name: Notify Slack on Failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: "CI Failed on main branch"
          fields: repo,message,commit,author,action,workflow
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

